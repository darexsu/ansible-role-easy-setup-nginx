server {
    listen       {{ nginx_virtualhost.vars.listen_port }};
{% if nginx_virtualhost.vars.listen_ipv6 %}
    listen       [::]:{{ nginx_virtualhost.vars.listen_port }} ipv6only=on default_server;
{% endif %}
{% if nginx_virtualhost.vars.server_name %}
    server_name {{ nginx_virtualhost.vars.server_name }};
{% endif %}
{% if nginx_virtualhost.vars.root %}
    root {{ nginx_virtualhost.vars.root }};
{% endif %}

    index {{ nginx_virtualhost.vars.index }};

{% if nginx_virtualhost.vars.error_page  %}
     {{ nginx_virtualhost.vars.error_page }};
{% endif %}
{% if nginx_virtualhost.vars.access_log %}
    access_log /var/log/nginx/{{ nginx_virtualhost.vars.server_name }}.access.log main;
{% endif %}
{% if nginx_virtualhost.vars.error_log %}
    error_log /var/log/nginx/{{ nginx_virtualhost.vars.server_name }}.error.log;
{% endif %}

{% if nginx_virtualhost.vars.php_fpm.tcp_ip_socket.enabled or nginx_virtualhost.vars.php_fpm.unix_socket.enabled %}
location ~ \.php$ {

        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        {% if nginx_virtualhost.vars.php_fpm.tcp_ip_socket.enabled %}
        fastcgi_pass {{ nginx_virtualhost.vars.php_fpm.tcp_ip_socket.ip }};
        {% endif %}
        {% if php_fpm.vars.unix_socket.enabled %}
        {% if ansible_os_family == "Debian" %}
        fastcgi_pass unix:/var/run/php/{{ php_fpm.vars.unix_socket.file }};
        {% endif %}
        {% if ansible_os_family == "RedHat" and php_repo.remi.enabled %}
        fastcgi_pass unix:/var/opt/remi/php{{ php.version | replace('.','')}}/run/php-fpm/{{ php_fpm.vars.unix_socket.file }};
        {% endif %}
        {% if ansible_os_family == "RedHat" and not php_repo.remi.enabled %}
        fastcgi_pass unix:/var/run/php-fpm/{{ php_fpm.vars.unix_socket.file }};
        {% endif %}
        {% endif %}
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
}
{% endif %}

}
