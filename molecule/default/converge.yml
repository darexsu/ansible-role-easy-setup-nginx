---
- name: Converge
  hosts: all
  become: true

  pre_tasks:
    - name: Unnessessary command
      ansible.builtin.shell:
        cmd: "{{ lookup('env', 'ANSIBLE_COMMAND') }}"
      when: lookup('env', 'ANSIBLE_COMMAND') | length > 0

  vars:
    merge:
      # Nginx
      nginx:
        enabled: true
        src: "third_party"
      # Nginx -> install
      nginx_install:
        enabled: true
        packages: [nginx]
      # Nginx -> config -> nginx.conf
      nginx_conf:
        enabled: true
        vars:
          user: "www-data"
          worker_processes: "auto"
          error_log: "/var/log/nginx/error.log notice"
          pidfile: "/var/run/nginx.pid"
          worker_connections: "1024"
      # Nginx -> config -> {virtualhost}.conf
      nginx_virtualhost:
      # Nginx -> config -> delete default.conf
        default_conf:
          enabled: true
          file: "default.conf"
          state: "absent"
      # Nginx -> config -> delete new.conf
        new_conf:
          enabled: true
          file: "new.conf"
          state: "present"
          src: "nginx__virtualhost.j2"
          backup: false
          vars:
            listen_port: "80"
            listen_ipv6: false
            server_name: "localhost"
            root: "/usr/share/nginx/html"
            index: "index.html index.htm index.php"
            error_page: ""
            access_log: false
            error_log: false
      # Nginx -> config -> new.conf -> enable tcp/ip
            tcp_ip_socket:
              enabled: true
              listen: "127.0.0.1:9000"
            unix_socket:
              enabled: false
              file: "php-fpm.sock"

  tasks:
    - name: role darexsu nginx
      include_role:
        name: darexsu.nginx